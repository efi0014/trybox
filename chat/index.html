<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare AI Web (Stable)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; background-color: #f4f6f8; color: #111; }
        html.dark body { background-color: #121212; color: #eee; }
        #chat-container { flex: 1; padding: 1rem; overflow-y: auto; }
        #form-container { padding: 1rem; border-top: 1px solid #ddd; background-color: #fff; }
        html.dark #form-container { border-top-color: #333; background-color: #1e1e1e;}
        #chat-form { display: flex; max-width: 800px; margin: 0 auto; }
        #chat-input { flex-grow: 1; padding: 0.75rem; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        html.dark #chat-input { background-color: #333; border-color: #555; color: #eee; }
        #model-select { padding: 0.75rem; margin-left: 0.5rem; border: 1px solid #ccc; border-radius: 8px; background-color: #fff; }
        html.dark #model-select { background-color: #333; border-color: #555; color: #eee; }
        #submit-button { margin-left: 0.5rem; padding: 0.75rem 1.5rem; border: none; background: #007aff; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #submit-button:disabled { background: #999; cursor: not-allowed; }
        .message-wrapper { margin-bottom: 1rem; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 80%; word-wrap: break-word; line-height: 1.6; }
        .user { display: flex; justify-content: flex-end; }
        .user .message-bubble { background: #007aff; color: white; border-bottom-right-radius: 0.25rem; }
        .assistant .message-bubble { background: #e5e5ea; color: #111; border-bottom-left-radius: 0.25rem; }
        html.dark .assistant .message-bubble { background: #333; color: #eee; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .thinking { color: #888; font-style: italic; }
    </style>
</head>
<body>

    <div id="chat-container"></div>

    <div id="form-container">
        <form id="chat-form">
            <input id="chat-input" autocomplete="off" placeholder="在此输入消息..." required>
            <select id="model-select">
                <option value="@cf/meta/llama-3-8b-instruct">Llama 3 8B</option>
                <option value="@cf/meta/llama-3.1-8b-instruct">Llama 3.1 8B</option>
                <option value="@cf/mistral/mistral-7b-instruct-v0.1">Mistral 7B</option>
                <option value="@cf/google/gemma-7b-it">Gemma 7B</option>
            </select>
            <button id="submit-button" type="submit">发送</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatContainer = document.getElementById('chat-container');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const modelSelect = document.getElementById('model-select');
            const submitButton = document.getElementById('submit-button');

            let messages = [];

            const addMessage = (content, sender) => {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${sender}`;

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble markdown-body';
                bubble.innerHTML = marked.parse(content); // Always parse as markdown
                
                wrapper.appendChild(bubble);
                chatContainer.appendChild(wrapper);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                return wrapper;
            };

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userInput = chatInput.value.trim();
                if (!userInput) return;

                addMessage(userInput, 'user');
                messages.push({ role: 'user', content: userInput });
                
                chatInput.value = '';
                submitButton.disabled = true;

                const thinkingMessage = addMessage('思考中...', 'assistant thinking');

                try {
                    const response = await fetch('/api/ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: messages,
                            model: modelSelect.value,
                        }),
                    });

                    // Remove "Thinking..." message
                    thinkingMessage.remove();

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const assistantResponse = data.response || '抱歉，我没有收到有效的回复。';

                    addMessage(assistantResponse, 'assistant');
                    messages.push({ role: 'assistant', content: assistantResponse });

                } catch (error) {
                    console.error('Fetch Error:', error);
                    addMessage(`**错误:** ${error.message}`, 'assistant');
                } finally {
                    submitButton.disabled = false;
                    chatInput.focus();
                }
            });
        });
    </script>

</body>
</html>
